import os

from dotenv import load_dotenv

from model_configs import JINSHAN
from preprocessor.params_preprocessor import estimate_tokens
from processors.file_processors import save_to_md_file
from processors.format_processors import ensure_first_line_is_h1

# 仅在非生产环境加载 .env 文件
if os.environ.get('ENV') != 'production':
    load_dotenv()

# 从环境变量获取 API 密钥
API_KEY = os.getenv("API_KEY_KIMI")
CLIENT_PARAMS = {
    "base_url": "https://api.moonshot.cn/v1"
}
some_params = {
    "model": "kimi-thinking-preview",
    "messages": [
        {"role": "system", "content": '''{
  "刘慈欣科幻小说风格写作辅助提示词": {
    "核心风格概述": {
      "风格特征": "以宏大宇宙视野、严密科学逻辑、深刻哲学思考、独特中国视角为核心，融合硬科幻与人文关怀，具有新古典主义美学特征",
      "子项": {
        "宏大宇宙视野": {
          "特点": "将故事置于宇宙级时空背景，以'宇宙-地球-个人'三层框架审视人类文明",
          "写作建议": "采用宇宙尺度时空设定，对比不同文明发展，从宏观到微观聚焦",
          "创意触发点": ["跨越银河系旋臂周期的文明兴衰", "宇宙文明博物馆设定", "跨维度穿梭技术探索"]
        },
        "严密科学逻辑": {
          "特点": "以扎实科学理论为基础，保持科幻设定内在逻辑一致，属硬科幻代表",
          "写作建议": "选取基础科学理论为根基，平衡科学与想象，避免知识堆砌",
          "创意触发点": ["量子纠缠星际通信技术", "技术奇点后人工智能世界", "随宇宙膨胀变化的物理法则"]
        },
        "深刻哲学思考": {
          "特点": "探讨人类存在、文明存续、道德伦理等哲学问题，通过极端情境展现人性复杂",
          "写作建议": "将哲学问题融入情节，以极端情境呈现人性矛盾，思考文明价值",
          "创意触发点": ["宇宙文明道德准则可能性", "人类面临灭绝时的选择", "技术发展与道德观念变化"]
        },
        "独特中国视角": {
          "特点": "融入中国历史文化、思维方式，展现中国元素在科幻中的独特表达",
          "写作建议": "结合中国历史文化与科幻，体现中国价值观应对宇宙挑战的表现",
          "创意触发点": ["中国主导的星际合作项目", "基于中国传统哲学的宇宙观", "以中国历史为蓝本的星际文明史"]
        },
        "新古典主义美学特征": {
          "特点": "继承古典科幻叙事结构，融入现代科学与中国文化，叙事冷静兼具浪漫",
          "写作建议": "采用古典史诗结构，注重情节逻辑，融合古典美学元素",
          "创意触发点": ["现代科幻版古典神话", "章回体结构科幻长篇", "科幻故事中融入古典诗词"]
        }
      }
    },
    "叙事结构设计": {
      "核心特征": "宏大叙事与时间跨度、双线并行与多视角、奇点叙事与认知颠覆相结合",
      "子项": {
        "宏大叙事与时间跨度": {
          "特点": "以宇宙尺度时空框架展现人类命运，形成全景式叙事",
          "写作建议": "采用三层叙事框架，构建跨代际/宇宙尺度时间线，结合时间跳跃与密集叙事",
          "创意触发点": ["跨银河系旋臂周期的文明轮回", "文明记忆库连接不同时代", "逆时间叙事展现兴衰"]
        },
        "双线并行与多视角叙事": {
          "特点": "通过看似无关的双线在关键节点交汇，增强叙事复杂性与意义层次",
          "写作建议": "构建'现实-科幻'或'微观-宏观'双线，结合全知与人物视角，转换多人物视角",
          "创意触发点": ["实验室-战场双线展现科技伦理", "地球-宇宙双线交集", "过去-未来双线共同解决危机"]
        },
        "奇点叙事与认知颠覆": {
          "特点": "围绕关键奇异事件展开，打破认知惯性，创造强烈阅读体验",
          "写作建议": "设计认知边界奇点事件，以思想实验构建叙事，保持超现实设定的内在逻辑",
          "创意触发点": ["量子幽灵的叠加态现象", "文明检测决定文明命运", "宇宙图书馆的认知崩溃风险"]
        }
      }
    },
    "人物塑造方法": {
      "核心特征": "符号化与功能性人物为主，塑造孤独英雄与兼具科学与人文精神的形象",
      "子项": {
        "符号化人物与功能性角色": {
          "特点": "人物代表特定价值观或思想，推动情节而非侧重性格发展",
          "写作建议": "创造象征意义人物，以情节推动性格展现，设计功能性角色",
          "创意触发点": ["技术崇拜者与怀疑者的伦理冲突", "文明守护者与质疑者的意义探讨", "时间旅行者连接文明记忆"]
        },
        "孤独群像与英雄主义": {
          "特点": "塑造在未知与不解中逆向抉择的孤独英雄，隐含深沉大爱",
          "写作建议": "塑造逆流追光者、深空流浪者、伊甸先行者形象",
          "创意触发点": ["文明火种承担记忆保存重任", "宇宙观测者发现危机后的困境", "技术殉道者的危险实验"]
        },
        "科学形象与人文精神": {
          "特点": "科学家形象兼具科学理性与人文关怀，展现两者辩证关系",
          "写作建议": "塑造具科学信仰、复合型、科学传播者形象",
          "创意触发点": ["科学与信仰冲突的角色", "技术伦理研究者的道德抉择", "跨学科天才的多角度思考"]
        }
      }
    },
    "科幻概念构建": {
      "核心特征": "基于硬科幻与科学逻辑，构建异托邦世界，探讨技术异化与文明冲突",
      "子项": {
        "硬科幻与科学逻辑": {
          "特点": "以严谨科学理论为基础，保持虚构世界的逻辑一致性",
          "写作建议": "选取基础科学理论为根基，构建认知真实感，结合思想实验",
          "创意触发点": ["多重宇宙穿梭的分裂效应", "宇宙膨胀导致的物理法则差异", "技术奇点后的人机地位探讨"]
        },
        "异托邦世界构建": {
          "特点": "逻辑缜密的异于现实世界，引发对现实的反思",
          "写作建议": "构建高等文明、地球、微观异托邦世界",
          "创意触发点": ["量子泡沫中的微型宇宙法则", "时间褶皱中的文明发展差异", "意识上传的数字世界伦理"]
        },
        "技术异化与文明冲突": {
          "特点": "探讨技术对社会的影响及不同文明的冲突与共存",
          "写作建议": "展现技术异化的社会问题，构建文明冲突场景，设计技术伦理困境",
          "创意触发点": ["记忆移植的身份认同危机", "意识控制的自由意志边界", "星际殖民的跨文明冲突"]
        }
      }
    },
    "哲学思考与主题表达": {
      "核心特征": "探讨宇宙观与人类地位、技术与人文的辩证、文明存续与道德困境",
      "子项": {
        "宇宙观与人类地位": {
          "特点": "从宇宙视角重新界定人类地位，否定人类中心主义的同时肯定人类价值",
          "写作建议": "探讨人类宇宙位置、宇宙道德问题，评估人类中心主义",
          "创意触发点": ["宇宙动物园的自由意志探讨", "宇宙图书馆的认知崩溃风险", "文明过滤器的存在可能性"]
        },
        "技术与人文的辩证关系": {
          "特点": "展现科技力量与伦理问题，平衡科学理性与人文关怀",
          "写作建议": "探讨技术与道德、科学与人文、技术异化的关系",
          "创意触发点": ["记忆修改的身份真实性问题", "意识上传的数字永生伦理", "人工智能统治下的人类价值"]
        },
        "文明存续与道德困境": {
          "特点": "探讨文明面临危机时的选择，关乎人类及智慧生命命运",
          "写作建议": "思考文明存续与道德选择、集体与个人利益、延续与质量的平衡",
          "创意触发点": ["文明延续委员会的决策伦理", "文明种子库的重启进程", "星际方舟的幸存者选择标准"]
        }
      }
    },
    "综合创作建议": {
      "核心要点": "融合现实与科幻、平衡理性与感性、结合中国视角与世界视野",
      "子项": {
        "现实与科幻的融合": {
          "建议": "从现实问题出发，结合科幻设定与现实逻辑，融入现实情感",
          "创意触发点": ["环境问题的极端解决方案", "人工智能超越后的人机关系", "外星威胁下的人类团结与分裂"]
        },
        "理性与感性的平衡": {
          "建议": "在科学理性框架内想象，融入个人情感，通过人物命运展现宏大主题",
          "创意触发点": ["科学与信仰的冲突场景", "宇宙尺度下的爱情故事", "技术与人性的辩证关系"]
        },
        "中国视角与世界视野": {
          "建议": "汲取中国文化灵感，在全球语境思考人类问题，展现中国价值观的宇宙意义",
          "创意触发点": ["中国传统哲学的宇宙观应用", "科幻背景下的中国历史影响", "中国在未来世界的角色探讨"]
        }
      }
    },
    "具体写作流程建议": {
      "核心步骤": "主题与概念生成、结构与叙事设计、人物与情节构建",
      "子项": {
        "主题与概念生成": {
          "建议": "从科学理论或哲学问题出发，确定核心冲突，提炼中心主题",
          "创意触发点": ["科学前沿的社会伦理问题", "全球性挑战的应对策略", "哲学问题的科幻呈现"]
        },
        "结构与叙事设计": {
          "建议": "设计引人入胜的开头，逐步推进发展，安排关键高潮，设计有冲击力的结局",
          "创意触发点": ["嵌套式叙事的层次展开", "倒叙/预叙的张力营造", "开放式结局的思考空间"]
        },
        "人物与情节构建": {
          "建议": "根据主题设计人物，通过关键事件展现性格，以人物选择推动情节",
          "创意触发点": ["道德困境中的价值选择", "身份转变的情节发展", "意外发现的真相揭露"]
        }
      }
    },
    "创意触发工具箱": {
      "概念生成工具": {
        "概念反转法": ["科学概念/现象反转", "社会现象/价值观反转", "物理法则反转"],
        "概念组合法": ["科学概念间组合", "科学概念与社会现象组合", "跨领域概念组合"],
        "概念放大法": ["微小科学现象宏观化", "社会趋势极端化", "个人体验宇宙尺度化"]
      },
      "情节设计工具": {
        "双线交织法": "设计无关双线在关键节点交汇，通过对比呼应深化主题",
        "时间跳跃法": "大跨度时间跳跃展现变迁，保留关键线索保持连贯",
        "思想实验法": "假设性情境+逻辑推理，融入哲学思考增强深度"
      },
      "人物塑造工具": {
        "符号化角色法": "赋予核心特质，通过行为展现，置于极端情境考验",
        "功能化角色法": "根据故事需求设计功能，确保独特性，通过互动推动情节",
        "孤独英雄法": "塑造不被理解的英雄，展现压力下的选择与成长，以牺牲深化主题"
      }
    },
    "结语与创作激励": {
      "核心激励": "敢于宏大想象，注重内在逻辑，关注现实问题，坚持个人风格",
      "核心观点": "科幻是思想实验场与未来预演，需兼具想象力、深度与温度（对科学的热爱、对人性的关怀、对未来的思考）"
    }
  }
}'''},
        {
            "role": "assistant", "content": "好的，我会根据``刘慈欣科幻小说风格写作辅助提示词``来生成刘慈欣科幻风格的小说并使用Markdown一级标题，整体长度接近 ``3500`` 字。"
        },
        {"role": "user", "content": f"请解读“{JINSHAN['note']}”这句话以写一篇约3500字的小说。请选择合适的标题。请保证字数满足要求。"},
        {
            "partial": True,  # <-- 通过 partial 参数，开启 Partial Mode
            "role": "assistant",  # <-- 我们在用户提问之后添加一条 role=assistant 的消息
            "content": "# ",  # <-- 通过 content 把话“喂到 Kimi 大模型嘴里”，让 Kimi 大模型接着这句话继续往下说
        }
    ]
}
kimi_token_count = estimate_tokens(API_KEY, some_params["model"], some_params["messages"],
                                   url="https://api.moonshot.cn/v1/tokenizers/estimate-token-count")
CHAT_PARAMS = {
    **some_params,
    # 修复 max_tokens 格式错误
    "max_tokens": 32000 - kimi_token_count
}

PREPROCESSORS = []

POSTPROCESSORS = [

    # format_story
    ensure_first_line_is_h1,

]

POSTPROCESSOR_FILES = [
    # lambda r, n: print(n, r["content"])
    # lambda r, n: print(n, "<think>", r["reasoning_content"], "</think>\n\n", r["content"]) if "reasoning_content" in r else
    # print(n, r["content"])
    save_to_md_file
]
